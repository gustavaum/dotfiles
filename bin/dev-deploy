#!/bin/sh
#
# Usage: dev-deploy <repo> <branch> <host>
#
# Deploy the branch specified by <branch> from the repo <repo> to the
# host specified by the -t option
#
# Make sure that you've defined two environment variables before using this script
#   GITHUB_USER - your GitHub username
#   GITHUB_TOKEN - A personal access token from GitHub with at least `read:org` access

HOST=$3
REPO=$1
BRANCH=$2

if [ "$REPO" == "--current" ]; then
    HOST="$2"
    REPO=`basename $PWD`
    BRANCH=`git srf --short`
fi

echo "Deploying $BRANCH of $REPO to $HOST"
curl -X POST \
 --user "$GITHUB_JENKINS_USER:$GITHUB_JENKINS_TOKEN" \
 --data-urlencode json='{"parameter": [{"name":"DEPLOY_ENV", "value": "'$HOST'"}, {"name":"DEPLOY_TARGET", "value":"'$REPO'"}, {"name":"DEPLOY_BRANCH", "value":"'$BRANCH'"}]}' \
 jenkins.prod.env.teladoc.com/job/deploy-dev/build
